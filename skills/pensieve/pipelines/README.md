# Pipelines（流程）

可执行工作流，用于定义从输入到验证再到输出的闭环。

> 说明：内置工具已迁移到 `tools/`。插件不再内置 pipelines。初始 pipelines 在安装/迁移时种子化到 `.claude/skills/pensieve/pipelines/`，用户可编辑。

## 目的

Pipeline 的目标是构建**可验证的执行闭环**，而不是堆信息。

在 Pensieve 中，先做语义分层，再决定是否需要 pipeline：
- `knowledge` = IS（是这样）
- `decision` = WANT（我想这样）
- `maxim` = MUST（必须这样）
- `pipeline` = HOW（怎么按顺序执行并验证）

Pipeline 负责编排流程，不负责存储知识。背景信息应拆到其他载体并通过链接引用：

- **Knowledge**：外部标准、参考资料、检查项
- **Maxims**：跨场景原则
- **Decisions**：上下文决策与理由
- **外部 skills/tools**：专用能力与重指令

## 写 Pipeline 前的反问（必须）

在落笔前先问：

**“这段内容是否直接改变 task 的顺序、输入、步骤或完成标准？”**

- 如果答案是“否”，这段内容不应放在 pipeline 主体，必须拆出去并用 `[[...]]` 引用。
- 如果答案是“是”，才保留在 pipeline 主体。

快速拆分规则：
1. 原理、理论、长解释 -> `knowledge`
2. 项目取舍、策略结论 -> `decision`
3. 跨场景原则 -> `maxim`
4. pipeline 仅保留：任务编排 + 验证闭环 + 关键约束

### 何时不该写 pipeline

以下情况默认不新建 pipeline：

- 主要问题是“定位慢、判断慢”，不是“步骤顺序混乱”
- 结论主要是约束/边界/反模式，缺少固定步骤
- 同类任务还未重复出现，流程还在变化

这些内容应按语义层分别写入 `knowledge` / `decision` / `maxim`，而不是直接写 pipeline。

闭环模型：

```
Input -> Execute -> Validate -> Output
         ^        |
         +-- Feedback --+
```

## 好的 Pipeline 长什么样

| 特征 | 价值（LLM 视角） |
|---|---|
| 闭环明确 | 防止漂移，清楚知道何时开始/结束 |
| 使用真实信号 | 用真实输出验证，而非“看起来对” |
| 文件化留痕 | 可追溯，能定位问题步骤 |
| 可测试 | 不依赖“感觉正确” |
| 工具友好 | 明确哪些步骤应借助工具降不确定性 |

## 验证必须依赖真实反馈

反模式：读代码 -> 感觉正确 -> 继续

正确方式：执行 -> 拿到输出/日志 -> 基于结果判断

| 验证类型 | 真实反馈来源 |
|---|---|
| 构建 | 编译输出、构建日志 |
| 测试 | 测试结果、覆盖率 |
| 运行时 | 应用日志、错误栈 |
| 集成 | API 响应、DB 状态 |

关键点：优先系统反馈，不依赖模型臆断。

## 捕获标准

核心问题：**如果不固化这个流程，哪些决策会被反复重做？**

### 是否需要新建 pipeline

先判断：能否通过组合现有 pipeline 解决？

| 情况 | 动作 |
|---|---|
| 现有 pipeline 组合可覆盖 | 组合/重排，不新增 |
| 仅缺少验证步骤 | 在现有 pipeline 增补 |
| 执行闭环完全不同 | 新建 pipeline |

新增前必须再过一层门禁：

- 至少出现过多次相同任务结构
- 步骤顺序不可交换
- 每步都能定义可验证完成标准

### 适合沉淀的信号

| 信号 | 说明 |
|---|---|
| 多个 loop 出现相同任务结构 | 步骤已稳定，可抽象 |
| 某步骤反复漏掉 | 需要 pipeline 强制约束 |
| 依赖多个知识来源协同 | 需要流程统一编排 |

### 演化路径

1. 先达到可运行基线（哪怕验证先手动）
2. 再把脆弱/重复步骤工具化
3. 最后做步骤重排，减少回退

反模式：还没跑通就追求“完美设计”。

## 关系与演化

| 方向 | 说明 |
|---|---|
| Pipeline <- Knowledge | 外部标准约束流程 |
| Pipeline -> Tasks | Pipeline 定义蓝图，Task 执行实例 |
| Pipeline <-> Decision | 执行中的决策可反哺流程 |

## 链接规则（Pipeline 强制）

每条 pipeline 正文至少包含一条显式链接，用于追溯来源与影响。

推荐字段：
- `基于`：依赖哪些 decision/knowledge
- `导致`：触发哪些输出或后续流程
- `相关`：相邻流程或关联主题

Hard rule：
- 任何不直接服务于任务编排的长段落，都必须迁移到被链接文件中。

## Pipeline 与 Tasks 区分

| 类型 | 本质 | 关注点 |
|---|---|---|
| Pipeline | 任务蓝图 + 验证闭环 | “按什么顺序做什么” |
| Tasks | 运行时实例 | “现在执行哪一步” |

Pipeline 应直接产出可实例化任务模板。

## 编写规范

### 目录结构

```
.claude/skills/pensieve/pipelines/
├── run-when-*.md
```

### 命名约定

Hard rule（必须）：
- pipeline 文件名必须使用触发意图风格：`run-when-*.md`
- 不保留旧命名兼容（如 `review.md` 必须改名）

| 命名模式 | 类型 | 说明 |
|---|---|---|
| `run-when-*.md` | 用户定义 | 从文件名直接看出“何时调用” |
| `_*.md` | 禁止 | 历史系统命名，不再使用 |

### 文件模板

```markdown
# Pipeline 名称

---
id: run-when-xxx
type: pipeline
title: Pipeline 名称
status: active
created: YYYY-MM-DD
updated: YYYY-MM-DD
tags: [pensieve, pipeline]
description: [强约束场景 + 跳过代价 + 触发词]。示例：在 X 场景必须执行此 pipeline；跳过会导致 Y 风险。触发词：a / b / c。
---

## 信号门禁（必须）

- 只输出高信号结果（可复现、可定位、有证据）
- 候选问题必须经过验证再进入最终输出
- 明确置信度阈值（例如 >=80）
- 明确“不报告项”（风格偏好、猜测风险等）

## Task Blueprint（按顺序创建任务）

### Task 1: 任务名

**目标**: 本任务目标

**读取输入**:
1. 必读文件/路径
2. 必读文件/路径

**执行步骤**:
1. 具体动作
2. 具体动作

**完成标准**: 可验证的完成条件

---

### Task 2: 任务名

**目标**: 本任务目标

**读取输入**:
1. 上一步输出

**执行步骤**:
1. 具体动作
2. **验证候选结果并过滤误报**

**完成标准**: 只保留高信号结果

---

### Task 3: 最终输出

**目标**: 输出可执行结果

**读取输入**:
1. 前序任务输出

**执行步骤**:
1. 按严重级别输出最终结果
2. 每条结论附证据（文件/行号/规则来源）
3. 给出修复优先级和下一步

**完成标准**: 报告可直接执行

---

## 失败回退（必须）

1. 输入缺失：返回缺失项并停止，不强行执行。
2. 证据不足：标记“无法验证”并过滤，不进入最终输出。
3. 全部候选被过滤：明确输出“无高信号问题”。

## 执行规则

1. 按 Task 顺序 1:1 创建执行任务，不合并、不跳步。
2. 信息缺失在当前任务补齐，不额外新增 phase。
3. 只在可复用且有证据时沉淀到 knowledge/decision/maxim/pipeline。

## 相关文件（可选）

- `path/to/file` — 说明
```

### 格式检查清单

| 要素 | 要求 |
|---|---|
| 文件名 | 必须为 `run-when-*.md`，从文件名即可判断触发场景 |
| frontmatter 必填 | `id/type/title/status/created/updated/tags/description` |
| `description` | 位于 frontmatter，包含触发词 |
| 信号门禁 | 必须声明高信号阈值与不报告项 |
| 不堆知识 | 长背景放到 Knowledge/Maxims/Decisions/Skills |
| 内容拆分 | 若段落不影响 task 编排，必须拆分并改为 `[[...]]` 引用 |
| Task Blueprint | 必须显式 `Task 1/2/3...` 顺序 |
| **目标** | 每个任务必须有 |
| **读取输入** | 文件/路径必须写清 |
| **执行步骤** | 编号、具体、可执行 |
| **完成标准** | 必须可验证 |
| **CRITICAL** / **DO NOT SKIP** | 关键步骤强提示 |
| 失败回退 | 必须有明确 fallback |
| 链接 | 正文至少一条有效链接 |

## 备注

- Pipeline 应轻量且可执行
- 每次只解决一个闭环问题，避免超大流程
- 不确定时先最小可运行版本，再迭代
